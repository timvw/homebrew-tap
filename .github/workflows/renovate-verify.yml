name: renovate verify

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'Formula/qv.rb'
      - 'Formula/bose.rb'

jobs:
  verify:
    if: github.event.pull_request.user.login == 'renovate[bot]'
    strategy:
      matrix:
        os: [ubuntu-24.04, macos-15]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect formula changes
        id: formula-changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            qv:
              - 'Formula/qv.rb'
            bose:
              - 'Formula/bose.rb'

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Link checkout as tap source
        run: |
          set -euo pipefail
          tap_dir="$(brew --repository)/Library/Taps/timvw/homebrew-tap"
          rm -rf "$tap_dir"
          mkdir -p "$(dirname "$tap_dir")"
          ln -s "$PWD" "$tap_dir"

      - name: Cache Homebrew Bundler RubyGems
        uses: actions/cache@v5
        with:
          path: ${{ steps.set-up-homebrew.outputs.gems-path }}
          key: ${{ runner.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
          restore-keys: ${{ runner.os }}-rubygems-

      - name: Install qv (mac only)
        if: steps.formula-changes.outputs.qv == 'true' && matrix.os == 'macos-15'
        run: brew install --build-bottle timvw/tap/qv

      - name: Test qv (mac only)
        if: steps.formula-changes.outputs.qv == 'true' && matrix.os == 'macos-15'
        run: |
          brew test timvw/tap/qv
          brew audit --strict timvw/tap/qv

      - name: Upload qv bottles
        if: steps.formula-changes.outputs.qv == 'true' && matrix.os == 'macos-15'
        uses: actions/upload-artifact@v6
        with:
          name: qv-bottles-${{ matrix.os }}
          path: '*.bottle.*'

      - name: Install bose (mac only)
        if: steps.formula-changes.outputs.bose == 'true' && matrix.os == 'macos-15'
        run: |
          brew install timvw/tap/bose
          file "$(which bose)"

      - name: Test bose (mac only)
        if: steps.formula-changes.outputs.bose == 'true' && matrix.os == 'macos-15'
        run: |
          brew test timvw/tap/bose
          brew audit --strict timvw/tap/bose

      - name: Verify bose artifact available (linux)
        if: steps.formula-changes.outputs.bose == 'true' && matrix.os == 'ubuntu-24.04'
        run: |
          bose_url=$(brew ruby -e 'puts Formula["timvw/tap/bose"].stable.url')
          curl --head --fail "$bose_url"
